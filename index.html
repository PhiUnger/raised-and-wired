<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenSenseMap - Live Sensor Daten</title>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; background-color: #f4f4f4; }
        .chart-container { width: 95%; max-width: 800px; margin: 20px auto; background: white; padding: 10px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body>
    <h1>InnRaum³ Passau</h1>
    <h2>Teilautomatisiertes Forschungshochbeet</h2>
    <h2>Live Sensor Daten von OpenSenseMap</h2>

    <div class="chart-container"><div id="outsideChart"></div></div>
    <div class="chart-container"><div id="lightChart"></div></div>
    <div class="chart-container"><div id="moistureChart"></div></div>
    <div class="chart-container"><div id="soilTempChart"></div></div>

    <script>
        const boxId = "67ced7745efb39000781a237";
        const sensors = {
            air_temp: "67d9756db6275400077d4d18",
            humidity: "67d9756db6275400077d4d1a",
            pressure: "67d9756db6275400077d4d1c",

            light_covered: "67d9650db62754000763b9eb",
            light_open: "67d9650db62754000763b9ed",

            soil_moist_q1: "67d9730fb62754000779a126",
            soil_moist_q2: "67d9735fb6275400077a1d02",
            soil_moist_q3: "67d9735fb6275400077a1d04",
            soil_moist_q4: "67d9735fb6275400077a1d08",

            soil_temp_q1: "67d9639fb627540007616fcc",
            soil_temp_q2: "67d963d9b62754000761c7b5",
            soil_temp_q3: "67d963d9b62754000761c7b7",
            soil_temp_q4: "67d963d9b62754000761c7b9"
        };

        async function fetchSensorData(sensorId) {
            const now = new Date().toISOString();
            const aMonthAgo = new Date(new Date().getTime() - (28 * 24 * 60 * 60 * 1000)).toISOString();
            const url = `https://api.opensensemap.org/boxes/${boxId}/data/${sensorId}?from-date=${aMonthAgo}&to-date=${now}&format=json`;

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Fehler beim Abrufen von Sensor ${sensorId}`);
                const data = await response.json();
                const sortedData = data.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));

                return {
                    timestamps: sortedData.map(d => new Date(d.createdAt).toISOString()),
                    values: sortedData.map(d => parseFloat(d.value))
                };
            } catch (error) {
                console.error("API-Fehler:", error);
                return { timestamps: [], values: [] };
            }
        }

        async function createMultiLineChart(chartId, sensorMap, title, yLabel) {
            const traces = [];
            for (const [label, id] of Object.entries(sensorMap)) {
                const data = await fetchSensorData(id);
                traces.push({
                    x: data.timestamps,
                    y: data.values,
                    mode: 'lines',
                    name: label
                });
            }

            Plotly.newPlot(chartId, traces, {
                title: title,
                xaxis: {
                    title: "Zeit",
                    type: "date",
                    rangeselector: {
                        buttons: [
                            { count: 1, label: '1d', step: 'day', stepmode: 'backward' },
                            { count: 7, label: '1w', step: 'day', stepmode: 'backward' },
                            { step: 'all', label: 'All' }
                        ]
                    },
                    rangeslider: { visible: true }
                },
                yaxis: { title: yLabel },
                dragmode: "pan"
            }, {
                displayModeBar: true,
                modeBarButtonsToRemove: ["zoom2d", "select2d", "lasso2d"],
                displaylogo: false,
                scrollZoom: true
            });
        }

        async function renderAllCharts() {
            await createMultiLineChart("outsideChart", {
                "Außentemperatur (°C)": sensors.air_temp,
                "Luftfeuchtigkeit (%)": sensors.humidity,
                "Luftdruck (hPa)": sensors.pressure
            }, "Außenbedingungen", "Wert");

            await createMultiLineChart("lightChart", {
                "Licht (überdacht)": sensors.light_covered,
                "Licht (frei)": sensors.light_open
            }, "Lichtverhältnisse", "Helligkeit (Lux)");

            await createMultiLineChart("moistureChart", {
                "Bodenfeuchte Q1": sensors.soil_moist_q1,
                "Bodenfeuchte Q2": sensors.soil_moist_q2,
                "Bodenfeuchte Q3": sensors.soil_moist_q3,
                "Bodenfeuchte Q4": sensors.soil_moist_q4
            }, "Bodenfeuchtigkeit", "%");

            await createMultiLineChart("soilTempChart", {
                "Bodentemperatur Q1": sensors.soil_temp_q1,
                "Bodentemperatur Q2": sensors.soil_temp_q2,
                "Bodentemperatur Q3": sensors.soil_temp_q3,
                "Bodentemperatur Q4": sensors.soil_temp_q4
            }, "Bodentemperatur", "°C");
        }

        renderAllCharts();
        setInterval(renderAllCharts, 60000);
    </script>
</body>
</html>
